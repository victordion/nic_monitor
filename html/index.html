<html>
<head lang="en">

    <meta charset="UTF-8">
    <title>NIC monitor</title>
    <link href="main.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="display-container">
    <canvas id="myChart" class="chart"></canvas>
    <div class="controls-container">
        Span In minutes <input type=number id="SpanInMinutes" value=10>
        <a id="refresh-button" class="refresh-button">Refresh</a>
    </div>
</div>>

</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.bundle.js"></script>
<script>

    var xmlHttp = new XMLHttpRequest();
    var ctx = document.getElementById("myChart");
    var refreshButton = document.getElementById('refresh-button');

    xmlHttp.onload = function(e) {
        if (xmlHttp.status === 200) {
            var spanInMinutes = document.getElementById("SpanInMinutes").value;
            draw(spanInMinutes);
        } else {
            console.log("HTTP request does not get Status 200 as response status")
        }
    };

    refreshButton.onclick = function() {
        var spanInMinutes = document.getElementById("SpanInMinutes").value;
        httpGet("http://jcui.info:9991/rx?endTimeStamp=" + currentTimeInSeconds() + "&spanInMinutes=" + spanInMinutes);
        draw(spanInMinutes);
    };

    var spanInMinutes = document.getElementById("SpanInMinutes").value;
    httpGet("http://jcui.info:9991/rx?endTimeStamp=" + currentTimeInSeconds() + "&spanInMinutes=" + spanInMinutes);
    draw(10);

    function currentTimeInSeconds() {
        return (new Date).getTime() / 1000
    }

    function httpGet(theUrl) {
        xmlHttp.open("GET", theUrl, true); // true for asynchronous request
        xmlHttp.send(null);
    }

    function draw(spanInMinutes) {
        var response = xmlHttp.response;
        console.log(response);
        var obj = JSON.parse(response);
        var labels = Object.keys(obj);
        var times = [];
        for (var i = 0; i < labels.length; i++) {
            times.push(new Date(parseInt(labels[i]) * 1000).toLocaleTimeString())
        }

        //var rawdata = Object.values(obj);
        var rawdata = Object.keys(obj).map(function(key) {
            return obj[key];
        });

        var usage = [];
        for (i = 0; i < rawdata.length; i++) {
            if (i == 0) {
                usage.push(0)
            }
            else {
                usage.push(rawdata[i] - rawdata[i - 1])
            }
        }

        console.log("Current time in seconds is " + currentTimeInSeconds)
        console.log(times);
        console.log(usage);

        var data = {
            labels: times,
            datasets: [
                {
                    label: "RX Usage on jcui.info",
                    fill: false,
                    lineTension: 0.1,
                    backgroundColor: "rgba(75,192,192,0.4)",
                    borderColor: "rgba(75,192,192,1)",
                    borderCapStyle: 'butt',
                    borderDash: [],
                    borderDashOffset: 0.0,
                    borderJoinStyle: 'miter',
                    pointBorderColor: "rgba(75,192,192,1)",
                    pointBackgroundColor: "#fff",
                    pointBorderWidth: 1,
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: "rgba(75,192,192,1)",
                    pointHoverBorderColor: "rgba(220,220,220,1)",
                    pointHoverBorderWidth: 2,
                    pointRadius: 1,
                    pointHitRadius: 10,
                    data: usage,
                    spanGaps: false,
                }
            ]
        };

        var myChart = new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });
    }



</script>

</html>